version: "3.8"

services:
  lattice:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000" # Single port for both frontend and backend
    environment:
      # Required WorkOS credentials - set these in a .env file or pass them directly
      - WORKOS_API_KEY=${WORKOS_API_KEY}
      - WORKOS_CLIENT_ID=${WORKOS_CLIENT_ID}

      # Optional environment variables with defaults
      - BASE_URL=${BASE_URL:-http://localhost:8000}
      - WORKOS_REDIRECT_URI=${WORKOS_REDIRECT_URI:-http://localhost:8000/api/v1/auth/callback}
      - WORKOS_COOKIE_PASSWORD=${WORKOS_COOKIE_PASSWORD}
      - DEBUG=${DEBUG:-false}
    volumes:
      # Optional: Mount for development (uncomment for live reload during development)
      # - ./backend:/app/backend
      # - ./frontend/src:/app/frontend/src
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:8000/api/v1/').raise_for_status()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
# Optional: Add a reverse proxy for production
# nginx:
#   image: nginx:alpine
#   ports:
#     - "80:80"
#     - "443:443"
#   volumes:
#     - ./nginx.conf:/etc/nginx/nginx.conf
#   depends_on:
#     - lattice
#   restart: unless-stopped
